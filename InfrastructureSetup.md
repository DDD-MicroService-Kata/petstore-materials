# Infrastructure Setup

This document provide a quick and straightforward way to prepare dev enviroment for the workshop via `docker`.

Basic infrastructure services needed for demonstration purpose may include:

- Docker
- Docker Registry
- Jenkins
- Pack Broker
- MySQL
- MongoDB
- Kafka

## Docker

Service containerize runtime tool. Installation is easy:

```
$ curl -sSL https://get.docker.com/ | sh
```

This service should be setup first, before any other ones below.

## Docker Registry

Before comamnd would setup a minimum docker container image registry, without Web UI.

```
$ docker run -d -p 5000:5000 --name registry \
       -v /opt/registry_data:/var/lib/registry \
       --restart always \
       registry:2
```

The service run on `http` protocol by default, which is not trusted by docker. So an explicit `--insecure-registry` paramter is needed on `dockerd` service.

```
$ sudo sed -i 's#/usr/bin/dockerd#/usr/bin/dockerd \
       --insecure-registry 10.71.84.160:5000#' \
       /lib/systemd/system/docker.service
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
```

## Jenkins

Open source delivery pipeline dashboard. You could start its container via docker command:

```
$ docker run -dt --name jenkins \
       --network=host \
       --restart always \
       -e JENKINS_OPTS="--httpPort=8000" \
       -v /opt/jenkins_data:/var/jenkins_home \
       jenkinsci/jenkins
```

Service run on `8000` port on the host.

Prepare a machine with `java`, `maven`, `docker` and `git` installed, then add it to jenkins as a slave node with tag `microservice`.

Prepare a machine with `docker` install as dev deployment node. Add the jenkins slave node's ssh public key into `${HOME}/.ssh/authorized_keys` file of the deployment node.

## Pact Broker

This service would hold all pactfiles generated by consumer driven contract test.

Below installation step is original recorded [here](https://github.com/DiUS/pact_broker-docker/blob/master/POSTGRESQL.md).

- 1. create postgres databases service

```
$ docker run -d --name pactbroker-db \
       -e POSTGRES_PASSWORD=ThePostgresPassword \
       -e POSTGRES_USER=admin \
       -e PGDATA=/data/pgdata \
       -v /opt/postgresql:/data \
       postgres
```

- 2. create pactbroker database

```
$ docker run -it --rm --link pactbroker-db:postgres \
         postgres sh -c 'exec psql -U admin \
         -h "$POSTGRES_PORT_5432_TCP_ADDR" \
         -p "$POSTGRES_PORT_5432_TCP_PORT"'
> CREATE USER pactbrokeruser WITH PASSWORD 'TheUserPassword';
> CREATE DATABASE pactbroker WITH OWNER pactbrokeruser;
> GRANT ALL PRIVILEGES ON DATABASE pactbroker TO pactbrokeruser;
```

- 3. create pact broker service

```
$ docker run -d --name pactbroker \
         --link pactbroker-db:postgres \
         -e PACT_BROKER_DATABASE_USERNAME=pactbrokeruser \
         -e PACT_BROKER_DATABASE_PASSWORD=TheUserPassword \
         -e PACT_BROKER_DATABASE_HOST=postgres \
         -e PACT_BROKER_DATABASE_NAME=pactbroker \
         -p 2000:80 \
         dius/pact-broker
```

Service run on `2000` port on the host.

## Mongo

NoSQL service.

- 1. create mongo

```
$ docker run -d --name mongo \
       -v /opt/mongo:/data/db \
       --network=host mongo --auth
```

- 2. setup user

```
$ docker exec -it mongo mongo admin
> db.createUser({ user: 'root', pwd: 'root', roles: [ { role: "root", db: "admin" } ] });
```

- 3. test connection

```
$ docker run -it --rm --network=host mongo \
         mongo -u root -p root \
         --authenticationDatabase admin \
         localhost/demo-db
> db.getName();
```

Service run on `27017` port on the host, with user `root` password `root`.

## MySQL

Relational database service.

```
docker run -d --name mysql \
       -v /opt/mysql:/var/lib/mysql \
       --network=host \
       -e MYSQL_ROOT_PASSWORD=root \
       mysql
```

Service run on `3306` port on the host, with user `root` password `root`.

## Kafka

TBD.
